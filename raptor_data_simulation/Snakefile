import subprocess
import os.path

# All parameters are set in config.yaml
configfile: "../simulation_config.yaml"

# Parameters for data simulation 
bin_dir = config["raptor_bin_dir"]
out_dir = config["data_out_dir"]

# Simulating reference
part_nr = config["reference_parts"]
length = config["ref_size"]
bin_nr = config["number_of_bins"]
ht = config["haplotype_count"]

# Simulating reads
epr = config["errors_per_read"]
rl = config["read_length"]
rpg = config["reads_per_genome"]

# An equal number of reads is sampled from each genome
rc = rpg * ht * bin_nr

# Helper variables
bins = [*range(0, bin_nr - 1, 1)]
parts =[*range(0, part_nr, 1)]

rule make_all:
	input:
		reads = expand("{out}/part_{part}/reads/{bin}.fastq", out=out_dir, part=parts, bin=bins)
#expand("{out}/part_{part}/ref.fasta", out=out_dir, part=parts)
	params:
		t = 1
	resources:
		nodelist = "cmp[227]"
	shell:
		"echo 'Done'"

rule create_ref:		
	output:
		"{out}/part_{part}/ref.fasta"
	params:
		t = 11
	resources:
		nodelist = "cmp[241]"
	shell:
		"./scripts/create_ref.sh {bin_dir} {out_dir} {length} {wildcards.part}"

rule divide_into_bins:		
	input:
		"{out}/part_{part}/ref.fasta"
	output:
		expand("{out}/part_{part}/bins/{bin}.fasta", out=out_dir, part=parts, bin=bins)
	params:
		t = 2
	resources:
		nodelist = "cmp[241]"
	shell:
		"./scripts/divide_into_bins.sh {bin_dir} {out_dir} {length} {wildcard.part} {bin_nr} {ht}"

rule sample_reads:
	input:
		"{out}/part_{part}/bins/{bin}.fasta"
	output:
		"{out}/part_{part}/reads/{bin}.fastq"
	params:
		t = 40
	resources:
		nodelist = "cmp[241]"
	shell:
		"""
		./scripts/sample_reads.sh {bin_dir} {out_dir} {wildcard.part} {bin_nr} {epr} {rl} {rc} {ht}
		./scripts/mix_bins.sh {out_dir} {wildcard.part}
		"""
